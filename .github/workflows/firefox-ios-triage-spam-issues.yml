name: Triage Spam Issues

on:
  issues:
    types: [opened]

jobs:
  triage-spam:
    if: github.event.issue.user.login != 'data-sync-user'
    runs-on: ubuntu-latest
    permissions:
      models: read
      issues: write

    steps:
      - name: Print issue details
        run: |
          echo "## Issue Details" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ github.event.issue.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.event.issue.user.login }}" >> $GITHUB_STEP_SUMMARY

      - name: Classify issue
        id: classify
        uses: actions/ai-inference@v1
        with:
          token: ${{ github.token }}
          model: openai/gpt-4o-mini
          max-tokens: 120
          system-prompt: |
            You are a spam classifier for the Firefox iOS GitHub issue tracker.
            Firefox iOS is an open-source iOS browser maintained by Mozilla.
            Its issue tracker receives bug reports, crash reports, feature requests,
            and UI issues from real users and contributors.

            SPAM: Content unrelated to a mobile browser (marketing, SEO, crypto, job offers),
            gibberish or auto-generated text, body is only external links, phishing URLs.
            Lack of reproducible steps or details may not be spam.
            Note that some Firefox fans may file desktop browser bugs here. Such issues aren't
            spam if they seem genuine. Only allow issues written in English.

            LEGITIMATE: bugs, crash reports (even if brief) or feature requests
            about Firefox iOS, partially filled templates with genuine intent.

            Reply with ONLY a raw JSON object â€” no markdown, no explanation.
            Required keys: classification ("spam" or "legitimate"),
            confidence ("high", "medium", or "low"), reason (one short sentence).
          prompt: |
            Issue title: ${{ github.event.issue.title }}
            Issue body:
            ${{ github.event.issue.body }}

      - name: Print classification result
        if: steps.classify.conclusion == 'success'
        run: |
          RESPONSE='${{ steps.classify.outputs.response }}'
          CLASSIFICATION=$(echo "$RESPONSE" | jq -r '.classification')
          CONFIDENCE=$(echo "$RESPONSE" | jq -r '.confidence')
          REASON=$(echo "$RESPONSE" | jq -r '.reason')
          echo "## Classification Result" >> $GITHUB_STEP_SUMMARY
          echo "- **Classification**: $CLASSIFICATION" >> $GITHUB_STEP_SUMMARY
          echo "- **Confidence**: $CONFIDENCE" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: $REASON" >> $GITHUB_STEP_SUMMARY

      - name: Label as spam
        if: steps.classify.conclusion == 'success' && fromJson(steps.classify.outputs.response).classification == 'spam'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create "spam" --color "F9A8A8" --repo ${{ github.repository }} --force
          gh issue edit ${{ github.event.issue.number }} --add-label "spam" --repo ${{ github.repository }}
